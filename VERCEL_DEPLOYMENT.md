# Deploying to Vercel with Neon PostgreSQL

This guide provides step-by-step instructions for deploying your Shopify FTP Order Sync app to Vercel with Neon PostgreSQL from the Vercel marketplace.

## Prerequisites

- A [Vercel account](https://vercel.com/signup)
- Your code pushed to a GitHub repository
- A [Shopify Partner account](https://partners.shopify.com/signup)

## Step 1: Connect Your Repository to Vercel

1. Log in to your [Vercel dashboard](https://vercel.com/dashboard)
2. Click "Add New" > "Project"
3. Import your GitHub repository
4. Select the repository containing your Shopify app

## Step 2: Configure Project Settings

1. In the project configuration screen:
   - Framework Preset: Select "Remix"
   - Build and Output Settings: Leave as default (they're configured in vercel.json)
   - Root Directory: Leave as default (/)

## Step 3: Deploy Your Project First

1. Click "Deploy" to create your Vercel project
2. Wait for the initial deployment to complete (it may fail due to missing database configuration, which is expected)
3. This creates your project in Vercel, which is needed before adding integrations

## Step 4: Set Up Neon PostgreSQL

1. After the initial deployment, go to your project dashboard
2. Navigate to the "Integrations" tab
3. Search for "Neon" in the marketplace
4. Click on "Neon" and then "Add Integration"
5. Follow the prompts to create a new Neon project or connect to an existing one
6. Once connected, Neon will provide a `DATABASE_URL` environment variable
7. Vercel will automatically add this environment variable to your project

## Step 5: Add Shopify Environment Variables

Add the following environment variables in the Vercel project settings:

1. `SHOPIFY_API_KEY`: Your Shopify API key from the Partner Dashboard
2. `SHOPIFY_API_SECRET`: Your Shopify API secret from the Partner Dashboard
3. `SHOPIFY_APP_URL`: Your Vercel deployment URL (e.g., https://your-app-name.vercel.app)
4. `SCOPES`: Your Shopify app scopes (e.g., write_orders,read_orders,write_products,read_products)
5. `NODE_ENV`: Set to `production`

## Step 6: Redeploy Your App

1. Go to the "Deployments" tab in your project dashboard
2. Find your latest deployment and click "Redeploy"
3. Select "Redeploy with existing Build Cache" option
4. Vercel will rebuild and deploy your application with the database connection
5. Once deployed, you'll get a URL for your application (e.g., https://your-app-name.vercel.app)

## Step 7: Set Up Database Schema

Since we've modified the build script to skip migrations (to avoid migration conflicts), you'll need to set up the database schema manually:

1. Access your Neon PostgreSQL database using the Neon console or a PostgreSQL client
2. Create the required tables using the schema defined in your Prisma schema
3. Alternatively, you can run a one-time migration using the Vercel CLI:
   ```bash
   # Install Vercel CLI if you haven't already
   npm install -g vercel
   
   # Login to Vercel
   vercel login
   
   # Link to your project
   vercel link
   
   # Pull environment variables
   vercel env pull .env
   
   # Run Prisma migration
   npx prisma migrate deploy
   ```

## Step 8: Update Shopify App Configuration

1. Go to your [Shopify Partner Dashboard](https://partners.shopify.com/organizations)
2. Navigate to your app
3. Update the App URL to your Vercel deployment URL
4. Update the Allowed redirection URL(s) to include:
   - `https://your-app-name.vercel.app/auth/callback`
   - `https://your-app-name.vercel.app/auth/shopify/callback`
   - `https://your-app-name.vercel.app/api/auth/callback`
5. Save your changes

## Step 9: Test Your Deployment

1. Install your app on a development store
2. Verify that the app loads correctly
3. Test the FTP functionality by creating a test order

## Troubleshooting

### Database Migrations

If you encounter database migration issues:

1. If you see an error about the datasource provider in migration_lock.toml not matching your schema, make sure the file at `prisma/migrations/migration_lock.toml` has:
   ```toml
   # Please do not edit this file manually
   # It should be added in your version-control system (e.g., Git)
   provider = "postgresql"
   ```

2. For other migration issues:
   - Go to your Vercel project dashboard
   - Navigate to "Deployments" > select your latest deployment
   - Click "Redeploy" with the "Clear cache and redeploy" option

### Environment Variables

If your app isn't connecting to Shopify or the database:

1. Check that all environment variables are correctly set in Vercel
2. Ensure the `SHOPIFY_APP_URL` matches your actual Vercel deployment URL
3. Verify that the Shopify API key and secret are correct

### Logs

To check for errors:

1. Go to your Vercel project dashboard
2. Navigate to "Deployments" > select your latest deployment
3. Click on "Functions" to see the serverless function logs

## Updating Your App

When you push changes to your GitHub repository, Vercel will automatically redeploy your application. Make sure to:

1. Test changes locally before pushing
2. Check the deployment logs for any errors
3. Verify the app works correctly after deployment

## Additional Resources

- [Vercel Documentation](https://vercel.com/docs)
- [Neon Documentation](https://neon.tech/docs/introduction)
- [Prisma with Neon](https://neon.tech/docs/guides/prisma)
- [Shopify App Deployment](https://shopify.dev/docs/apps/deployment/web)
